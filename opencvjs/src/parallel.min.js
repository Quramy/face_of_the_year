!function(){function t(t,e){e||(e={});for(var r in t)void 0===e[r]&&(e[r]=t[r]);return e}function e(){this._callbacks=[],this._errCallbacks=[],this._resolved=0,this._result=null}function r(r,o){this.data=r,this.options=t(l,o),this.operation=new e,this.operation.resolve(null,this.data),this.requiredScripts=[],this.requiredFunctions=[]}var o="undefined"!=typeof global&&"[object global]"=={}.toString.call(global),n=n||function(t){setTimeout(t,0)},s=o?require(__dirname+"/Worker.js"):self.Worker,a="undefined"!=typeof self?self.URL?self.URL:self.webkitURL:null,i=o||self.Worker?!0:!1;e.prototype.resolve=function(t,e){if(t){this._resolved=2,this._result=t;for(var r=0;r<this._errCallbacks.length;++r)this._errCallbacks[r](e)}else{this._resolved=1,this._result=e;for(var o=0;o<this._callbacks.length;++o)this._callbacks[o](e)}this._callbacks=[],this._errCallbacks=[]},e.prototype.then=function(t,e){return 1===this._resolved?(t&&t(this._result),void 0):2===this._resolved?(e&&e(this._result),void 0):(t&&(this._callbacks[this._callbacks.length]=t),e&&(this._errCallbacks[this._errCallbacks.length]=e),this)};var l={evalPath:o?__dirname+"/eval.js":null,maxWorkers:o?require("os").cpus().length:4,synchronous:!0};r.isSupported=function(){return i},r.prototype.getWorkerSource=function(t){var e="",r=0;for(o||0===this.requiredScripts.length||(e+='importScripts("'+this.requiredScripts.join('","')+'");\r\n'),r=0;r<this.requiredFunctions.length;++r)e+=this.requiredFunctions[r].name?"var "+this.requiredFunctions[r].name+" = "+this.requiredFunctions[r].fn.toString()+";":this.requiredFunctions[r].fn.toString();return o?e+'process.on("message", function(e) {process.send(JSON.stringify(('+t.toString()+")(JSON.parse(e).data)))})":e+"self.onmessage = function(e) {self.postMessage(("+t.toString()+")(e.data))}"},r.prototype.require=function(){for(var t,e=Array.prototype.slice.call(arguments,0),r=0;r<e.length;r++)t=e[r],"string"==typeof t?this.requiredScripts.push(t):"function"==typeof t?this.requiredFunctions.push({fn:t}):"object"==typeof t&&this.requiredFunctions.push(t);return this},r.prototype._spawnWorker=function(t){var e,r=this.getWorkerSource(t);if(o)e=new s(this.options.evalPath),e.postMessage(r);else{if(void 0===s)return void 0;try{if(0!==this.requiredScripts.length){if(null===this.options.evalPath)throw new Error("Can't use required scripts without eval.js!");e=new s(this.options.evalPath),e.postMessage(r)}else{if(!a)throw new Error("Can't create a blob URL in this browser!");var n=new Blob([r],{type:"text/javascript"}),i=a.createObjectURL(n);e=new s(i)}}catch(l){if(null===this.options.evalPath)throw l;e=new s(this.options.evalPath),e.postMessage(r)}}return e},r.prototype.spawn=function(t){var r=this,o=new e;return this.operation.then(function(){var e=r._spawnWorker(t);if(void 0!==e)e.onmessage=function(t){e.terminate(),r.data=t.data,o.resolve(null,r.data)},e.postMessage(r.data);else{if(!r.options.synchronous)throw new Error("Workers do not exist and synchronous operation not allowed!");n(function(){r.data=t(r.data),o.resolve(null,r.data)})}}),this.operation=o,this},r.prototype._spawnMapWorker=function(t,e,r){var o=this,s=o._spawnWorker(e);if(void 0!==s)s.onmessage=function(e){s.terminate(),o.data[t]=e.data,r()},s.postMessage(o.data[t]);else{if(!o.options.synchronous)throw new Error("Workers do not exist and synchronous operation not allowed!");n(function(){o.data[t]=e(o.data[t]),r()})}},r.prototype.map=function(t){function r(){++s===o.data.length?a.resolve(null,o.data):n<o.data.length&&o._spawnMapWorker(n++,t,r)}if(!this.data.length)return this.spawn(t);var o=this,n=0,s=0,a=new e;return this.operation.then(function(){for(;n-s<o.options.maxWorkers&&n<o.data.length;++n)o._spawnMapWorker(n,t,r)}),this.operation=a,this},r.prototype._spawnReduceWorker=function(t,e,r){var o=this,s=o._spawnWorker(e);if(void 0!==s)s.onmessage=function(t){s.terminate(),o.data[o.data.length]=t.data,r()},s.postMessage(t);else{if(!o.options.synchronous)throw new Error("Workers do not exist and synchronous operation not allowed!");n(function(){o.data[o.data.length]=e(t),r()})}},r.prototype.reduce=function(t){function r(){--o,1===n.data.length&&0===o?(n.data=n.data[0],s.resolve(null,n.data)):n.data.length>1&&(++o,n._spawnReduceWorker([n.data[0],n.data[1]],t,r),n.data.splice(0,2))}if(!this.data.length)throw new Error("Can't reduce non-array data");var o=0,n=this,s=new e;return this.operation.then(function(){if(1===n.data.length)s.resolve(null,n.data[0]);else{for(var e=0;e<n.options.maxWorkers&&e<Math.floor(n.data.length/2);++e)++o,n._spawnReduceWorker([n.data[2*e],n.data[2*e+1]],t,r);n.data.splice(0,2*e)}}),this.operation=s,this},r.prototype.then=function(t,r){var o=this,n=new e;return this.operation.then(function(){var e=t(o.data);void 0!==e&&(o.data=e),n.resolve(null,o.data)},r),this.operation=n,this},o?module.exports=r:self.Parallel=r}();